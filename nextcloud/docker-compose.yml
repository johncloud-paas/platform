version: "3"

services:
  nextcloud:
    container_name: nextcloud-aio-mastercontainer
    image: nextcloud/all-in-one:latest
    restart: unless-stopped
    depends_on:
      - nginx
    ports:
      - 8089:8080
    environment:
      - APACHE_PORT=11000
      # - APACHE_IP_BINDING=0.0.0.0
      - NEXTCLOUD_DATADIR=/mnt/nextcloud/data
    volumes:
      - ./nextcloud_aio_mastercontainer:/mnt/docker-aio-config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cloud.rule=Host(`cloud.johncloud.fr`)"
      - "traefik.http.routers.cloud.entrypoints=websecure"
      - "traefik.http.routers.cloud.tls.certresolver=letsencrypt"

  nginx:
    container_name: nginx
    image: nginx:1.21.6
    restart: unless-stopped
    ports:
      - 8239:80
      # - 443:443
    volumes:
      - ./nginx:/etc/nginx
      - ../emails/certs/cloud.johncloud.fr:/etc/letsencrypt/nextcloud
    labels:
      - "traefik.enable=false"

networks:
  default:
    external: true
    name: traefik-proxy
    