# https://blog.filador.fr/je-supervise-mon-traefik-avec-prometheus-et-grafana/
# https://github.com/loganmarchione/homelab-svg-assets/blob/main/ICONS.md
# https://joeeey.com/blog/selfhosting-sso-with-traefik-keycloak-part-1/#setting-up-keycloak
# https://goauthentik.io/docs/providers/proxy/server_traefik

services:
  traefik:
    image: traefik:latest
    container_name: traefik
    ports:
      - "80:80"
      - "443:443"
      - "465:465"
      - "587:587"
      - "993:993"
    restart: unless-stopped
    environment:
    # https://www.ovh.com/auth/api/createToken
    # https://eu.api.ovh.com/console/?section=%2Fme&branch=v1#delete-/me/api/application/-applicationId-
      - "OVH_ENDPOINT=$OVH_ENDPOINT"
      - "OVH_APPLICATION_KEY=$OVH_APPLICATION_KEY"
      - "OVH_APPLICATION_SECRET=$OVH_APPLICATION_SECRET"
      - "OVH_CONSUMER_KEY=$OVH_CONSUMER_KEY"
      - "TZ=$TZ"
    command:
      # - --entryPoints.metrics.address=:8082
      # - --entrypoints.smtp.address=:25  # SMTP - mostly processing incoming mails from remote mail servers
      - --entrypoints.smtps.address=:465 # SMTPS - Legacy SMTPs port
      # - --entrypoints.msa.address=:587 # MSA - SMTP port primarily used by email clients after STARTTLS and auth
      # - --entrypoints.pop3.address=:110 # POP3 - standard protocol for accessing mailbox, STARTTLS is required before client auth
      # - --entrypoints.pop3s.address=:995 # POP3S - POP3 port with encryption from the start of the connection
      # - --entrypoints.imap.address=:143 # IMAP - standard protocol for accessing mailbox, STARTTLS is required before client auth
      - --entrypoints.imaps.address=:993 # IMAPS - alternative port for IMAP with encryption from the start of the connection
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.http.tls.certresolver=letsencrypt
      - --entrypoints.websecure.http.tls.domains.main=$HOST
      - --entrypoints.websecure.http.tls.domains.sans=*.$HOST
      - --entrypoints.websecure.http.middlewares=default@file
      - --providers.docker=true
      - --providers.docker.exposedByDefault=false
      - --providers.file.directory=conf.d
      - --providers.file.watch=true
      - --api.dashboard=true
      - --api.insecure=true
      - --certificatesresolvers.letsencrypt.acme.email=$ADMIN_EMAIL
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik:/conf.d
      - $JOHNCLOUD_ROOT/traefik/letsencrypt:/letsencrypt
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.$HOST`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"

  certdumper:
    restart: unless-stopped
    image: ldez/traefik-certs-dumper:v2.8.1
    container_name: certdumper
    entrypoint: sh -c '
      apk add jq
      ; while ! [ -e /traefik/acme.json ]
      || ! [ `jq ".[] | .Certificates | length" /traefik/acme.json` != 0 ]; do
      sleep 1
      ; done
      && traefik-certs-dumper file --version v2 --watch
        --source /traefik/acme.json --dest /output
        --domain-subdir --crt-ext=.pem --key-ext=.pem'
    volumes:
      - $JOHNCLOUD_ROOT/traefik/letsencrypt:/traefik:ro
      - $JOHNCLOUD_ROOT/traefik/certs:/output
    depends_on:
      - traefik
    labels:
      - "traefik.enable=false"

  posteio:
    image: analogic/poste.io
    restart: unless-stopped
    # ports:
    #   - "465:465"
    #   - "587:587"
    #   - "993:993"
    # depends_on:
    #   - traefik
    volumes:
      - $JOHNCLOUD_ROOT/posteio:/data
    environment:
      TZ: $TZ
      HTTPS: OFF
      HTTP_PORT: 8534
      # HTTPS_PORT: 8535
      LETSENCRYPT_EMAIL: $ADMIN_EMAIL
      LETSENCRYPT_HOST: $ADMIN_EMAIL
      DISABLE_CLAMAV: $DISABLE_CLAMAV
      DISABLE_RSPAMD: $DISABLE_RSPAMD
      DISABLE_ROUNDCUBE: $DISABLE_ROUNDCUBE
    labels:
      - "traefik.enable=true"

      - "traefik.http.routers.posteio.rule=Host(`mail.$HOST`)"
      - "traefik.http.routers.posteio.entrypoints=websecure"
      - "traefik.http.routers.posteio.service=sposteio"
      - "traefik.http.routers.posteio.tls.certresolver=letsencrypt"
      - "traefik.http.services.sposteio.loadbalancer.server.port=8534"

      # # SMTPS (Port 465)
      # # - "traefik.tcp.routers.posteio-smtps.rule=HostSNI(`*`)"
      # - "traefik.tcp.routers.posteio-smtps.rule=HostSNI(`mail.$HOST`)"
      # # - "traefik.tcp.routers.posteio-smtps.tls.certresolver=letsencrypt"
      # - "traefik.tcp.routers.posteio-smtps.tls.passthrough=true"
      # - "traefik.tcp.routers.posteio-smtps.entrypoints=smtps"
      # - "traefik.tcp.routers.posteio-smtps.service=sposteio-smtps"
      # - "traefik.tcp.services.sposteio-smtps.loadbalancer.server.port=465"

      # # IMAPS (Port 993)
      # # - "traefik.tcp.routers.posteio-imaps.rule=HostSNI(`*`)"
      # - "traefik.tcp.routers.posteio-imaps.rule=HostSNI(`mail.$HOST`)"
      # # - "traefik.tcp.routers.posteio-imaps.tls.certresolver=letsencrypt"
      # - "traefik.tcp.routers.posteio-imaps.tls.passthrough=true"
      # - "traefik.tcp.routers.posteio-imaps.entrypoints=imaps"
      # - "traefik.tcp.routers.posteio-imaps.service=sposteio-imaps"
      # - "traefik.tcp.services.sposteio-imaps.loadbalancer.server.port=993"

      # # Submission (Port 587)
      # # - "traefik.tcp.routers.posteio-msa.rule=HostSNI(`*`)"
      # - "traefik.tcp.routers.posteio-msa.rule=HostSNI(`mail.$HOST`)"
      # # - "traefik.tcp.routers.posteio-msa.tls.certresolver=letsencrypt"
      # # - "traefik.tcp.routers.posteio-msa.tls.passthrough=true"
      # - "traefik.tcp.routers.posteio-msa.entrypoints=msa"
      # - "traefik.tcp.routers.posteio-msa.service=sposteio-msa"
      # - "traefik.tcp.services.sposteio-msa.loadbalancer.server.port=587"

      # IMAP (Port 143)
      - "traefik.tcp.routers.posteio-imap.rule=HostSNI(`mail.$HOST`)"
      - "traefik.tcp.routers.posteio-imap.tls.certresolver=letsencrypt"
      - "traefik.tcp.routers.posteio-imap.entrypoints=imaps"
      - "traefik.tcp.routers.posteio-imap.service=sposteio-imap"
      - "traefik.tcp.services.sposteio-imap.loadbalancer.server.port=143"

      # SMTP (Port 25)
      - "traefik.tcp.routers.posteio-smtp.rule=HostSNI(`mail.$HOST`)"
      - "traefik.tcp.routers.posteio-smtp.tls.certresolver=letsencrypt"
      - "traefik.tcp.routers.posteio-smtp.entrypoints=smtps"
      - "traefik.tcp.routers.posteio-smtp.service=sposteio-smtp"
      - "traefik.tcp.services.sposteio-smtp.loadbalancer.server.port=25"

networks:
  default:
    external: true
    name: traefik-proxy
    
