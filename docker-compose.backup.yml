name: backup

services:
  app:
    image: davidcrty/databasement:latest
    container_name: databasement
    volumes:
      - $JOHNCLOUD_ROOT/databasement/data:/data
    networks:
      - database
      - frontend
    restart: unless-stopped
    environment:
      - APP_URL=https://databasement.$HOST
      - APP_KEY=$DATABASEMENT_KEY
      - TZ=$TZ
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/data/database.sqlite
      - TRUSTED_PROXIES=$TRAEFIK_NET.0/24
      - OAUTH_OIDC_ENABLED=$DATABASEMENT_OAUTH_OIDC_ENABLED
      - OAUTH_OIDC_CLIENT_ID=$DATABASEMENT_OAUTH_OIDC_CLIENT_ID
      - OAUTH_OIDC_CLIENT_SECRET=$DATABASEMENT_OAUTH_OIDC_CLIENT_SECRET
      - OAUTH_OIDC_BASE_URL=$DATABASEMENT_OAUTH_OIDC_BASE_URL
      - OAUTH_OIDC_LABEL=$DATABASEMENT_OAUTH_OIDC_LABEL
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:2226/health"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.databasement.entryPoints=websecure"
      - "traefik.http.routers.databasement.rule=Host(`databasement.$HOST`)"
      - "traefik.http.routers.databasement.tls.certresolver=letsencrypt"
      - "traefik.http.routers.databasement.tls=true"
      - "traefik.http.services.databasement.loadbalancer.server.port=2226"
      - "homepage.group=Platform"
      - "homepage.name=Databasement"
      - "homepage.icon=sh-databasement"
      - "homepage.href=https://databasement.$HOST/"
      - "homepage.description=Database backup management application for MySQL, PostgreSQL, and MariaDB"

  worker:
    image: davidcrty/databasement:latest
    container_name: databasement-worker
    restart: unless-stopped
    command: sh -c "php artisan db:wait --check-migrations && php artisan queue:work --queue=backups,default --tries=3 --timeout=3600 --sleep=3 --max-jobs=1000"
    volumes:
      - $JOHNCLOUD_ROOT/databasement/data:/data
    environment:
      - APP_URL=https://databasement.$HOST
      - APP_KEY=$DATABASEMENT_KEY
      - TZ=$TZ
      - DB_CONNECTION=sqlite
      - DB_DATABASE=/data/database.sqlite
      - TRUSTED_PROXIES=$TRAEFIK_NET.0/24
      - OAUTH_OIDC_ENABLED=$DATABASEMENT_OAUTH_OIDC_ENABLED
      - OAUTH_OIDC_CLIENT_ID=$DATABASEMENT_OAUTH_OIDC_CLIENT_ID
      - OAUTH_OIDC_CLIENT_SECRET=$DATABASEMENT_OAUTH_OIDC_CLIENT_SECRET
      - OAUTH_OIDC_BASE_URL=$DATABASEMENT_OAUTH_OIDC_BASE_URL
      - OAUTH_OIDC_LABEL=$DATABASEMENT_OAUTH_OIDC_LABEL
    networks:
      - database
    depends_on:
      - app
        # condition: service_healthy
          
networks:
  frontend:
    external: true
    name: $TRAEFIK_NETWORK
  database:
    external: true
    name: $DATABASE_NETWORK
    